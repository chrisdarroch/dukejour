<%
  mdl = 'track'
  create_entry = jquery_xhr :create, Entry,
    :params => "'entry[track_id]': track_id",
    :callback => %Q(
      $('#queue').append(data);
      $('.ac_results').stop();
    )
%>

function email_to_selector(record_email) {
  return 'ul.copies li[class*=recipient_' + record_email + ']';
}

function email_to_li(record_email) {
  return jQuery('<li/>').addClass("recipient_" + record_email).append(
    jQuery('<span/>')
      .addClass('secondary').addClass('email').addClass('raw_email')
      .html(record_email)
  ).append('<%= escape_javascript(render :partial => "shared/statuses") %>');
}

function selectSearchResult() {
  var record, record_email;
  
  track_id = parseInt($(this).find('.track_id').html());
  
  if (0 < track_id) {
    <%= create_entry %>;

    jQuery('#suggest_<%= mdl %>')
      .val('').focus();
  }
  
  
  // only get the result if we have a valid record to fetch
  if (record_email && valid_email(record_email)) {
    // TODO this selects portions of superset addresses, need to only select entire class name
    current_entries_selector = email_to_selector(record_email);
    if (0 < jQuery(current_entries_selector).length) {
      // Record is already on the page; highlight it
      jQuery(current_entries_selector).show('highlight', {}, 3000);
    } else {
      create_copy(record, record_email, current_entries_selector);
    }
    jQuery('.ac_results').hide();
    jQuery('.new_recipient_message').hide();
  }
}

jQuery(function() {
  // Prevent submits
  jQuery("form:first").submit(function() { return false; });

  // When an entry in the completion list is ENTERinated, AJAX load the corresponding record
  jQuery("#suggest_<%= mdl %>")
    .keypress(function(e) {
      key = e.which;
      if ((KEYS.RETURN == key) || (KEYS.ENTER == key) || (KEYS.TAB == key)) {
        selectSearchResult();
      }
    });

  // Hook the suggestion code to the text field
  jQuery("#suggest_<%= mdl %>")
    .focus()
    .suggest("<%= suggest_tracks_path :fields => 'artist,album,name', :limit => 25 %>", { })
    .ajaxSuccess(function() {
      // Apply a click hook to each search result
      jQuery('.ac_results li').click(selectSearchResult);
    });
});

<%= javascript_for_ajax_response %>
